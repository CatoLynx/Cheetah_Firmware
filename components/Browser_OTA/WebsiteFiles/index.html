<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8">
    <title>ESP32 OTA</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <script src="jquery-3.4.1.min.js"></script>
  </head>

  <body style="font-family: Arial; background-color: #ccc;">
    <h1>ESP32 Firmware Update Page</h1>

    <input type="file" id="file-firmware" accept=".bin" />
    <div id="div-file-info">&nbsp;</div>
    <input type="submit" id="btn-submit" value="Update Firmware">
    <div id="div-upload-progress">&nbsp;</div>

    <script type="text/javascript">
      function setPayloadLength() {
        var fileSelect = $("#file-firmware")[0];
        if (fileSelect.files && fileSelect.files.length == 1) {
          var fileSize = fileSelect.files[0].size;
          $.post("/ota/length", fileSize.toString(), onSetPayloadLengthSuccess);
        } else {
          window.alert("Please select a file!");
        }
      }

      function onFileSelected() {
        var fileSelect = $("#file-firmware")[0];
        if (fileSelect.files && fileSelect.files.length == 1) {
          var fileSize = fileSelect.files[0].size;
          $("#div-file-info").html("File size: " + fileSize + " bytes");
        }
      }

      function startUpdate() {
        setPayloadLength();
      }

      function uploadFirmware() {
        var formData = new FormData();
        var file = $("#file-firmware")[0].files[0];
        formData.set("file", file, file.name);
        var xhr = new XMLHttpRequest();

        // Progress handler
        xhr.upload.addEventListener("progress", function(evt) {
          if (evt.lengthComputable) {
            var percentComplete = (evt.loaded / evt.total) * 100;
            var x = Math.floor(percentComplete);
            $("#div-upload-progress").html("Upload progress: " + x + "%");
          } else {
            console.log("Cannot compute progress!");
          }
        }, false);

        xhr.open("POST", "/ota");
        xhr.responseType = "blob";
        xhr.send(formData);
      }

      function onAjaxError(event, jqXHR, ajaxSettings, thrownError) {
        console.log("AJAX Error!");
        console.log(thrownError);
      }
      
      function onSetPayloadLengthSuccess(data, textStatus, jqXHR) {
        console.log("Successfully set payload size");
        uploadFirmware();
      }

      function onReady() {
        $(document).ajaxError(onAjaxError);
        $("#file-firmware").change(onFileSelected);
        $("#btn-submit").click(startUpdate);
      }

      $(document).ready(onReady);
    </script>
  </body>
</html>
